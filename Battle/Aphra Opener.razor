# Performs an initial salvo of 
# spells on a target

if targetexists 
    hotkey 'Cancel Current Target'
endif

overhead 'Salvo what?' 54
@setvar! monster

if not varexist monster
    overhead 'Must select a target.' 38
endif

if dead monster 
    overhead 'That is dead.' 36
    stop
endif

if noto monster = innocent
    overhead 'Cannot attack!' 38
    stop
elseif noto monster = hostile or noto monster = criminal
    overhead 'Attack salvo!' 54
else 
    overhead 'Invalid target!' 38
    stop
endif

clearsysmsg 
say 'all attack'
waitfortarget 1500
target monster

@setvar! magicArrowID 101
@setvar! fireballID 102
@setvar! harmID 103
@setvar! lightningID 104
@setvar! manaDrainID 201
@setvar! curseID 202

getlabel monster monsterName
@setvar! monsterDebuffTimer monster

if not timerexists monsterDebuffTimer
    createtimer monsterDebuffTimer
    settimer monsterDebuffTimer 60000
endif

#overhead monsterDebuffTimer

removelist spellOrder
removelist spellDelay

createlist spellOrder
createlist spellDelay

# only include debuffs every 1m
if timer monsterDebuffTimer >= 60000
    pushlist spellOrder manaDrainID
    pushlist spellDelay 1500

    pushlist spellOrder curseID
    pushlist spellDelay 1500
else
    overhead 'Debuffs on cooldown' 87
endif

pushlist spellOrder fireballID
pushlist spellDelay 1250

pushlist spellOrder magicArrowID
pushlist spellDelay 750

pushlist spellOrder harmID
pushlist spellDelay 1000

pushlist spellOrder lightningID
pushlist spellDelay 1250

@setvar! endSpellID lightningID

while not dead monster
    #overhead 'loop'
    
    if insysmsg 'Target cannot be seen'
        overhead 'CANNOT SEE!' 38
        stop
    else 
        if poplist spellOrder front as spellID and poplist spellDelay front as delay
            if spellID = manaDrainID                
                cast 'Mana Drain'
            elseif spellID = curseID
                cast 'Curse'
            elseif spellID = fireballID
                cast 'Fireball'    
            elseif spellID = magicArrowID
                cast 'Magic Arrow'
            elseif spellID = harmID
                cast 'Harm'
            elseif spellID = lightningID
                cast 'Lightning'
            else
                overhead 'Unknown spell!' 38
                stop
            endif
            
            #overhead 'delay = {{delay}}'
            wait delay
            waitfortarget 250
            
            if dead monster
                hotkey 'Cancel Current Target'
                stop
            endif
            
            target monster
            
            if insysmsg 'That is too far away'
                overhead 'TOO FAR!' 38
                stop
            elseif insysmsg 'Your concentration is distrubed' or insysmsg 'You have not yet recovered'
                # re-queue this spell and cast again
                pushlist spellOrder spellID front
                pushlist spellDelay delay front
                wait 100
            elseif spellID = endSpellID
                overhead 'SALVO FINISHED' 54
                stop
            else 
                if spellID = curseID or spellID = manaDrainID 
                    settimer monsterDebuffTimer 0
                endif
            endif
        else 
            overhead 'No spells in list!' 38
            break
        endif
    endif
    
    wait 200
endwhile