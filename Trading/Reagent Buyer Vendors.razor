# Recalls through a series of runes
# in a runebook or tome and purchases
# a grocery list of reagents.
# Supports using packies, and best used
# when you have 2 packies. When the first
# packie is overloaded, the overloaded
# resources are placed into the second,
# and the script will then return home
# to unload the purchases. 
overhead '-Buyer Vendors-' 24

# Purchase limits before returning home
if not varexist blackPearlLimit
    @setvar! blackPearlLimit 5000
    @setvar! mandrakeLimit 5000
    @setvar! bloodmossLimit 5000
    @setvar! garlicLimit 5000
    @setvar! ginsengLimit 5000
    @setvar! sulphurousAshLimit 5000
    @setvar! nightshadeLimit 5000
    @setvar! spidersSilkLimit 5000

    @setvar! bottleLimit 5000
    @setvar! scrollLimit 5000
endif

@clearignore 

# when set to 1 and currently buying reagents,
# instead of going to the next vendor, will
# return home and unload the purchases.
setvar! shouldReturnHome 0
@setvar! firstTarget 0

if diffweight < 50
    setvar! shouldReturnHome 1

    overhead 'Carrying too much!' 38
    sysmsg 'Carrying too much weight, puchases stopped.'
    
    overhead 'Returning to home...'
    script 'Reagent Buyer Return Home'                        
    stop
endif


@setvar! reachedLimit 0

while 1 = 1
    clearsysmsg 
    hotkey 'Next Target'
    
    if insysmsg 'New target set'
        @setvar! targetID lasttarget 
        getlabel lasttarget targetName
        #overhead '{{targetName}}'
   
        if insysmsg 'getlabel - Skipped'
            # Skipping player
            continue
        endif  
        
        if 'the mage' in targetName or 'the alchemist' in targetName
            overhead 'Found a vendor!' 54
        
            # buy what we can
            menu targetID 1
            wait 500
            
            # move purchased items to the packie
            # 3976|3981|3980|3973|3974|3962|3972|3963 = regs
            # 3854 = empty bottles
            # 3827 = scrolls
            overhead 'Looking for reagents to move the packie...'
            
            removelist foundItems
            createlist foundItems
            while findtype 3976|3981|3980|3973|3974|3962|3972|3963|3854|3827 self as item
                getlabel item itemName
                pushlist foundItems item back

                # do not move reagents from satchel
                if findtype 'reagent satchel' self as satchel
                    if find item satchel
                        overhead 'Ignoring {{itemName}} in satchel' 908
                        @ignore item
                        continue
                    endif
                endif
                
                # move purchased items to packie
                if followers > 0
                    while findtype 'a pack llama' ground any any 2 as packie
                        if noto packie = friend
                            overhead 'Moving {{itemName}}' 54
                            clearsysmsg 
                            lift item 60000
                            drop packie -1 -1 -1
                            wait 500
                            @ignore item
                            
                            if counttype item packie > 0
                                overhead 'we have some item!'
                            endif
                            
                            if insysmsg 'You are overloaded.'
                                overhead 'Packie is full!' 38
                                setvar! shouldReturnHome 1
                                @ignore packie
                            else
                                overhead 'Finished moving items.'
                            endif
                            
                            # Reagent Limits
                            if blackPearlLimit > 0 and counttype 3962 packie > blackPearlLimit
                                overhead 'Reached Black Pearl limit' 54
                                @setvar! reachedLimit 1
                            endif
                            if mandrakeLimit > 0 and counttype 3974 packie > mandrakeLimit
                                overhead 'Reached Mandrake limit' 54
                                @setvar! reachedLimit 1
                            endif
                            if bloodmossLimit > 0 and counttype 3963 packie > bloodmossLimit
                                overhead 'Reached Bloodmoss limit' 54
                                @setvar! reachedLimit 1
                            endif
                            if garlicLimit > 0 and counttype 3972 packie > garlicLimit
                                overhead 'Reached Garlic limit' 54
                                @setvar! reachedLimit 1
                            endif
                            if ginsengLimit > 0 and counttype 3973 packie > ginsengLimit
                                overhead 'Reached Ginseng limit' 54
                                @setvar! reachedLimit 1
                            endif
                            if sulphurousAshLimit > 0 and counttype 3980 packie > sulphurousAshLimit
                                overhead 'Reached Sulphuous Ash limit' 54
                                @setvar! reachedLimit 1
                            endif
                            if nightshadeLimit > 0 and counttype 3976 packie > nightshadeLimit
                                overhead 'Reached Night Shade limit' 54
                                @setvar! reachedLimit 1
                            endif
                            if spidersSilkLimit > 0 and counttype 3981 packie > spidersSilkLimit
                                overhead 'Reached Spider Silk limit' 54
                                @setvar! reachedLimit 1
                            endif
                            
                            # Misc Limits
                            if bottleLimit > 0 and counttype 3854 packie > bottleLimit
                                overhead 'Reached Empty Bottle limit' 54
                                @setvar! reachedLimit 1
                            endif
                            if scrollLimit > 0 and counttype 3827 packie > scrollLimit
                                overhead 'Reached Blank Scroll limit' 54
                                @setvar! reachedLimit 1
                            endif
                            
                            break
                        else 
                            @ignore packie
                        endif
                    endwhile
                endif
            endwhile
            
            if reachedLimit = 1
                setvar! shouldReturnHome 1
            endif
            

            # set the intial target if needed
            if firstTarget == 0
                @setvar! firstTarget targetID 
                overhead 'FIRST TARGET = {{firstTarget}}'
            elseif firstTarget == targetID 
                overhead 'Location complete' 89
            
                if isBuyingReagents = 1
                    if shouldReturnHome = 1
                        overhead 'Returning to home...'
                        script 'Reagent Buyer Return Home'
                    else
                        overhead 'Recalling to next location...'
                        script 'Reagent Buyer Recall'
                    endif
                else 
                    break
                endif
            endif  
        endif
    endif
endwhile
@clearignore 